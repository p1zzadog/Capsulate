angular.module("capsuleApp",["ui.router","ngMaterial","ngMessages","ngAnimate","ngFileUpload"]),angular.module("capsuleApp").config(["$stateProvider","$mdThemingProvider",function(e,o){e.state("home",{url:"",templateUrl:"/html/views/home/home.html",controller:"homeController as homeCtrl"}).state("home2",{url:"/",templateUrl:"/html/views/home/home.html",controller:"homeController as homeCtrl"}).state("login",{url:"/auth/login",templateUrl:"html/views/login/login.html",controller:"loginController as loginCtrl"}).state("dash",{url:"/view/dash",templateUrl:"html/views/dash/dash.html",controller:"dashController as dashCtrl"}),o.theme("default").primaryPalette("indigo").accentPalette("light-blue").warnPalette("red")}]),angular.module("capsuleApp").controller("navController",["$http","$mdSidenav","$window","$scope",function(e,o,t,a){var n=this;n.bannerClose=!1,n.sideNavOpen=function(){o("left").open()},n.sideNavClose=function(){o("left").close()},n.closeBanner=function(){n.bannerClose=!0},angular.element(t).bind("scroll",function(){this.pageYOffset>=850&&(n.bannerClose=!0),a.$apply()})}]),angular.module("capsuleApp").controller("dashController",["$http","Upload",function(e,o){function t(){e({method:"get",url:"/api/get-capsules"}).then(function(e){e.data.capsules&&(i.userCapsules=e.data.capsules,i.userCapsules.forEach(function(e){e.unlockWrapper=moment(e.unlockDate).format("dddd, MMMM Do YYYY"),e.creationWrapper=moment(e.creationDate).format("dddd, MMMM Do YYYY")}),r())})}function a(){e({method:"get",url:"/api/get-invites"}).then(function(e){e.data.capsules&&(i.inviteCapsules=e.data.capsules,i.inviteCapsules.forEach(function(e){e.unlockWrapper=moment(e.unlockDate).format("dddd, MMMM Do YYYY")}))})}function n(){e({method:"get",url:"/api/get-shared"}).then(function(e){e.data.capsules&&(i.sharedCapsules=e.data.capsules,i.sharedCapsules.forEach(function(e){e.unlockWrapper=moment(e.unlockDate).format("dddd, MMMM Do YYYY"),e.creationWrapper=moment(e.creationDate).format("dddd, MMMM Do YYYY")}),u())})}function l(o){e({method:"get",url:"/api/get-contributions/"+o._id}).then(function(e){i.contributions=e.data})}function r(){i.unlockedCapsule=[],i.openCapsuleButtonText=[];for(var e=0;e<i.userCapsules.length;e++)i.openCapsuleButtonText[e]="Open"}function u(){i.unlockedSharedCapsule=[],i.openSharedButtonText=[];for(var e=0;e<i.sharedCapsules.length;e++)i.openSharedButtonText[e]="Open"}function s(e,t){o.upload({url:"/api/upload-photo",method:"post",data:{file:e,capsuleId:t}}).then(function(e){console.log("Success "+e.config.data.file.name+"uploaded. Response: "+e.data)},function(e){console.log("Error status: "+e.status)},function(e){var o=parseInt(100*e.loaded/e.total);console.log("progress: "+o+"% "+e.config.data.file.name)})}var i=this;e({method:"get",url:"/api/me"}).then(function(e){e.data.user?(i.user=e.data.user,t(),a(),n()):window.location.href="/#/auth/login"}),i.createCapsuleForm={},i.createCapsuleForm.unlockDate=new Date,i.minDate=i.createCapsuleForm.unlockDate,i.maxDate=new Date(i.createCapsuleForm.unlockDate.getFullYear()+10,i.createCapsuleForm.unlockDate.getMonth(),i.createCapsuleForm.unlockDate.getDate()),i.createCapsuleForm.inviteFriends=[],i.createCapsule=function(){i.createCapsuleForm.creationDate=new Date,e({method:"post",url:"/api/create-capsule",data:i.createCapsuleForm}).then(function(e){e.data.success&&i.capsuleImageUpload&&("image/jpeg"===i.capsuleImageUpload.image.type||"image/png"===i.capsuleImageUpload.image.type?s(i.capsuleImageUpload.image,e.data.capsuleId):console.log({error:"upload invalid filetype"}))}),i.createCapsuleForm={},i.createCapsuleForm.inviteFriends=[],i.createCapsuleForm.unlockDate=new Date,t(),i.selectedIndex=1},i.openCapsule=function(o){i.unlockedCapsule[o]?(r(),u()):(r(),u(),i.unlockedCapsule=[],e({method:"get",url:"/api/open-capsule/"+i.userCapsules[o]._id}).then(function(e){i.unlockedCapsule[o]=e.data,i.openCapsuleButtonText[o]="Close!",l(i.unlockedCapsule[o])}))},i.openInvite=function(o){i.openedInvite=[],e({method:"get",url:"/api/open-invite/"+i.inviteCapsules[o]._id}).then(function(e){e.data.success?i.openedInvite[o]=!0:console.log(e.data.error)})},i.openShared=function(o){i.unlockedSharedCapsule[o]?(r(),u()):(r(),u(),i.unlockedSharedCapsule=[],e({method:"get",url:"/api/open-shared/"+i.sharedCapsules[o]._id}).then(function(e){i.unlockedSharedCapsule[o]=e.data,i.openSharedButtonText[o]="Close!",l(i.unlockedSharedCapsule[o])}))},i.submitContribution=function(o){i.inviteForm.capsuleId=i.inviteCapsules[o]._id,e({method:"post",url:"/api/submit-contribution",data:i.inviteForm}).then(function(e){e.data.success&&(i.openedInvite[o]=!1,a())}),i.inviteForm={}}}]),angular.module("capsuleApp").controller("homeController",["$http",function(e){}]),angular.module("capsuleApp").controller("loginController",["$http","$timeout",function(e,o){var t=this;e({method:"get",url:"/api/me"}).then(function(e){e.data.user?(t.user=e.data.user,t.loggedIn=!0):(console.log("ngDash /api/me error route",e.data),window.location.href="/#/auth/login",t.loggedIn=!1)}),t.processLogin=function(){e({method:"post",url:"/auth/process-login",data:t.loginForm}).then(function(e){e.data.success?window.location.href="/#/view/dash":(console.log("login error",e.data.error),t.loginError=!0,t.loginErrorMessage=e.data.error,o(function(){t.loginError=!1},1500))},function(e){console.log("loginCtrl.processLogin err error",e)})},t.processSignup=function(){e({method:"post",url:"/auth/register-user",data:t.signupForm}).then(function(e){e.data.success?window.location.href="/#/view/dash":console.log(e.data.error)},function(e){console.log(e)})}}]);